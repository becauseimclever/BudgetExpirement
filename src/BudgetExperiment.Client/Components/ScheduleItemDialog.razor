@inject IJSRuntime JS
@using Microsoft.FluentUI.AspNetCore.Components

<FluentDialog Hidden="@(!IsVisible)" 
              Modal="true" 
              Style="--dialog-width: 500px; --dialog-height: auto;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">
            @Title
        </FluentLabel>
    </FluentDialogHeader>

    <FluentDialogBody>
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            <!-- Name Field (for bills, pay schedules don't have names) -->
            @if (ShowNameField)
            {
                <FluentTextField @bind-Value="Model.Name"
                                 Label="@NameLabel"
                                 Placeholder="@NamePlaceholder"
                                 Style="width: 100%;" />
                @if (!string.IsNullOrEmpty(Model.NameError))
                {
                    <FluentLabel Style="color: var(--palette-red-foreground-1); font-size: 12px;">
                        @Model.NameError
                    </FluentLabel>
                }
            }

            <!-- Amount -->
            <FluentNumberField @bind-Value="Model.Amount"
                               Label="Amount ($)"
                               Placeholder="0.00"
                               Step="0.01m"
                               Min="0"
                               Style="width: 100%;" />
            @if (!string.IsNullOrEmpty(Model.AmountError))
            {
                <FluentLabel Style="color: var(--palette-red-foreground-1); font-size: 12px;">
                    @Model.AmountError
                </FluentLabel>
            }

            <!-- Anchor Date -->
            <div style="display: flex; flex-direction: column;">
                <FluentLabel Style="margin-bottom: 4px;">@DateLabel</FluentLabel>
                <input type="date" value="@Model.DateString" 
                       @onchange="@((e) => Model.DateString = e.Value?.ToString() ?? string.Empty)"
                       style="width: 100%; padding: 8px; border: 1px solid var(--neutral-stroke-control-default); border-radius: var(--control-corner-radius);" />
            </div>
            @if (!string.IsNullOrEmpty(Model.DateError))
            {
                <FluentLabel Style="color: var(--palette-red-foreground-1); font-size: 12px;">
                    @Model.DateError
                </FluentLabel>
            }

            <!-- Recurrence -->
            <FluentSelect TOption="string" 
                          @bind-Value="Model.Recurrence"
                          Label="Recurrence"
                          Style="width: 100%;">
                @foreach (var option in RecurrenceOptions)
                {
                    <FluentOption Value="@option">@option</FluentOption>
                }
            </FluentSelect>

            <!-- Days Interval (for custom recurrence) -->
            @if (ShowDaysIntervalField && Model.Recurrence == "Custom")
            {
                <FluentNumberField @bind-Value="Model.DaysInterval"
                                   Label="Days Interval"
                                   Placeholder="Enter number of days..."
                                   Min="1"
                                   Style="width: 100%;" />
                @if (!string.IsNullOrEmpty(Model.DaysIntervalError))
                {
                    <FluentLabel Style="color: var(--palette-red-foreground-1); font-size: 12px;">
                        @Model.DaysIntervalError
                    </FluentLabel>
                }
            }
        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="width: 100%;">
            <!-- Delete button (only show in edit mode) -->
            <div>
                @if (Model.IsEditMode && OnDelete.HasDelegate)
                {
                    <FluentButton Appearance="Appearance.Stealth" 
                                  OnClick="HandleDelete"
                                  Disabled="@(Model.IsSaving || Model.IsDeleting)"
                                  Style="color: var(--palette-red-foreground-1);">
                        @if (Model.IsDeleting)
                        {
                            <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 8px;" />
                        }
                        üóëÔ∏è Delete
                    </FluentButton>
                }
            </div>
            
            <!-- Cancel and Save buttons -->
            <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8">
                <FluentButton Appearance="Appearance.Neutral" OnClick="OnCancel">
                    Cancel
                </FluentButton>
                <FluentButton Appearance="Appearance.Accent" 
                              OnClick="OnSave"
                              Disabled="@(Model.IsSaving || Model.IsDeleting)"
                              Style="margin-left: 8px;">
                    @if (Model.IsSaving)
                    {
                        <FluentProgressRing Style="width: 16px; height: 16px; margin-right: 8px;" />
                    }
                    @SaveButtonText
                </FluentButton>
            </FluentStack>
        </FluentStack>
    </FluentDialogFooter>
</FluentDialog>

@code {
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public string Title { get; set; } = "Edit Schedule";
    [Parameter] public string NameLabel { get; set; } = "Name";
    [Parameter] public string NamePlaceholder { get; set; } = "Enter name...";
    [Parameter] public string DateLabel { get; set; } = "Anchor Date";
    [Parameter] public string SaveButtonText { get; set; } = "Save";
    [Parameter] public bool ShowNameField { get; set; } = true;
    [Parameter] public bool ShowDaysIntervalField { get; set; } = true;
    [Parameter] public List<string> RecurrenceOptions { get; set; } = new() { "Weekly", "BiWeekly", "Monthly", "Custom" };
    [Parameter] public ScheduleItemDialogModel Model { get; set; } = new();
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnDelete { get; set; }

    public class ScheduleItemDialogModel
    {
        public Guid? Id { get; set; }
        public bool IsEditMode { get; set; } = false;
        public string Name { get; set; } = string.Empty;
        public string Currency { get; set; } = "USD";
        public decimal? Amount { get; set; }
        public DateTime DateTime { get; set; } = DateTime.Today;
        public string Recurrence { get; set; } = "Monthly";
        public int? DaysInterval { get; set; }
        public bool IsSaving { get; set; }
        public bool IsDeleting { get; set; }

        public string DateString
        {
            get => DateTime.ToString("yyyy-MM-dd");
            set
            {
                if (System.DateTime.TryParse(value, out var result))
                {
                    DateTime = result;
                }
            }
        }

        public string? NameError { get; set; }
        public string? AmountError { get; set; }
        public string? DateError { get; set; }
        public string? DaysIntervalError { get; set; }

        public bool HasErrors => NameError != null || AmountError != null || DateError != null || DaysIntervalError != null;

        public void ClearErrors()
        {
            NameError = null;
            AmountError = null;
            DateError = null;
            DaysIntervalError = null;
        }

        public bool Validate(bool requireName = true)
        {
            ClearErrors();

            if (requireName && string.IsNullOrWhiteSpace(Name))
                NameError = "Name is required";

            if (!Amount.HasValue || Amount <= 0)
                AmountError = "Amount must be greater than 0";

            if (DateTime == default)
                DateError = "Date is required";

            if (Recurrence == "Custom" && (!DaysInterval.HasValue || DaysInterval <= 0))
                DaysIntervalError = "Days interval must be greater than 0 for custom recurrence";

            return !HasErrors;
        }
    }

    private async Task HandleDelete()
    {
        if (OnDelete.HasDelegate)
        {
            // Simple confirmation - detect type from title
            var itemType = Title?.ToLower().Contains("bill") == true ? "bill schedule" : "pay schedule";
            var confirmMessage = $"Are you sure you want to delete this {itemType}?";
            
            var confirmed = await JS.InvokeAsync<bool>("confirm", confirmMessage);
            
            if (confirmed)
            {
                await OnDelete.InvokeAsync();
            }
        }
    }
}
