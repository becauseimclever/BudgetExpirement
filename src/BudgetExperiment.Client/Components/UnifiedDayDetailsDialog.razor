@inject IJSRuntime JS
@using Microsoft.FluentUI.AspNetCore.Components
@using BudgetExperiment.Client.Api

<FluentDialog Hidden="@(!IsVisible)" 
              Modal="true" 
              Style="--dialog-width: 800px; --dialog-height: 80vh; max-width: 90vw;">
    <FluentDialogHeader>
        <FluentLabel Typo="Typography.H4">
            @Title
        </FluentLabel>
    </FluentDialogHeader>

    <FluentDialogBody Style="padding: 0;">
        <FluentStack Orientation="Orientation.Vertical" Style="height: 100%;">
            <!-- Action Buttons -->
            <FluentCard Style="margin: 16px; padding: 16px;">
                <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="8" Wrap="true">
                    <FluentButton Appearance="Appearance.Accent" 
                                  OnClick="() => OnAddIncomeSchedule.InvokeAsync()"
                                  Style="flex: 1; min-width: 140px; background: var(--palette-green-fill-rest);">
                        + Income Schedule
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Accent" 
                                  OnClick="() => OnAddExpenseSchedule.InvokeAsync()"
                                  Style="flex: 1; min-width: 140px; background: var(--palette-red-fill-rest);">
                        + Expense Schedule
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Accent" 
                                  OnClick="() => OnAddExpense.InvokeAsync()"
                                  Style="flex: 1; min-width: 120px; background: var(--palette-orange-fill-rest);">
                        + One-time Expense
                    </FluentButton>
                    <FluentButton Appearance="Appearance.Accent" 
                                  OnClick="() => OnAddPayment.InvokeAsync()"
                                  Style="flex: 1; min-width: 120px; background: var(--palette-blue-fill-rest);">
                        + One-time Payment
                    </FluentButton>
                </FluentStack>
            </FluentCard>

            <!-- Items List -->
            <FluentCard Style="margin: 0 16px 16px 16px; flex: 1; overflow-y: auto; min-height: 400px;">
                @if (!HasAnyItems)
                {
                    <div style="padding: 32px; text-align: center; color: var(--neutral-foreground-secondary);">
                        <FluentLabel Typo="Typography.Body">
                            No items scheduled for this day. Use the buttons above to add new items.
                        </FluentLabel>
                    </div>
                }
                else
                {
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="12" Style="padding: 20px;">
                        <!-- Recurring Schedules Section -->
                        @{
                            var incomeSchedules = RecurringSchedules?.Where(s => s.IsIncome).ToList() ?? new List<RecurringScheduleItem>();
                            var expenseSchedules = RecurringSchedules?.Where(s => s.IsExpense).ToList() ?? new List<RecurringScheduleItem>();
                        }
                        
                        @if (RecurringSchedules?.Any() == true)
                        {
                            <!-- Income Schedules -->
                            @if (incomeSchedules.Any())
                            {
                                <div style="margin-bottom: 16px;">
                                    <FluentLabel Typo="Typography.Body" Style="color: var(--palette-green-foreground-1); margin-bottom: 8px; display: block; font-weight: 600;">
                                        ?? Income Schedules (@incomeSchedules.Count)
                                    </FluentLabel>
                                    @foreach (var schedule in incomeSchedules)
                                    {
                                        <FluentCard Class="item-card income-schedule-item" 
                                                    Style="cursor: pointer; margin-bottom: 12px; padding: 16px;"
                                                    @onclick="() => OnEditRecurringSchedule.InvokeAsync(schedule)">
                                            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="align-items: center;">
                                                <div style="flex: 1;">
                                                    <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 16px;">
                                                        @schedule.DisplayName
                                                    </FluentLabel>
                                                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-secondary); display: block; font-size: 14px; margin-top: 4px;">
                                                        @schedule.Recurrence (@schedule.Anchor.ToString("MMM d, yyyy"))
                                                    </FluentLabel>
                                                </div>
                                                <FluentLabel Typo="Typography.Body" Style="color: var(--palette-green-foreground-1); font-weight: 600; font-size: 18px;">
                                                    @schedule.FormattedAmount
                                                </FluentLabel>
                                            </FluentStack>
                                        </FluentCard>
                                    }
                                </div>
                            }

                            <!-- Expense Schedules -->
                            @if (expenseSchedules.Any())
                            {
                                <div style="margin-bottom: 16px;">
                                    <FluentLabel Typo="Typography.Body" Style="color: var(--palette-red-foreground-1); margin-bottom: 8px; display: block; font-weight: 600;">
                                        ?? Expense Schedules (@expenseSchedules.Count)
                                    </FluentLabel>
                                    @foreach (var schedule in expenseSchedules)
                                    {
                                        <FluentCard Class="item-card expense-schedule-item" 
                                                    Style="cursor: pointer; margin-bottom: 12px; padding: 16px;"
                                                    @onclick="() => OnEditRecurringSchedule.InvokeAsync(schedule)">
                                            <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="align-items: center;">
                                                <div style="flex: 1;">
                                                    <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 16px;">
                                                        @schedule.DisplayName
                                                    </FluentLabel>
                                                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-secondary); display: block; font-size: 14px; margin-top: 4px;">
                                                        @schedule.Recurrence (@schedule.Anchor.ToString("MMM d, yyyy"))
                                                    </FluentLabel>
                                                </div>
                                                <FluentLabel Typo="Typography.Body" Style="color: var(--palette-red-foreground-1); font-weight: 600; font-size: 18px;">
                                                    @schedule.FormattedAmount
                                                </FluentLabel>
                                            </FluentStack>
                                        </FluentCard>
                                    }
                                </div>
                            }
                        }

                        <!-- One-time Expenses Section -->
                        @if (Expenses?.Any() == true)
                        {
                            <div style="margin-bottom: 16px;">
                                <FluentLabel Typo="Typography.Body" Style="color: var(--palette-orange-foreground-1); margin-bottom: 8px; display: block; font-weight: 600;">
                                    ?? One-time Expenses (@Expenses.Count)
                                </FluentLabel>
                                @foreach (var expense in Expenses)
                                {
                                    <FluentCard Class="item-card expense-item" 
                                                Style="cursor: pointer; margin-bottom: 12px; padding: 16px;"
                                                @onclick="() => OnEditExpense.InvokeAsync(expense)">
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="align-items: center;">
                                            <div style="flex: 1;">
                                                <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 16px;">
                                                    @expense.Description
                                                </FluentLabel>
                                                @if (!string.IsNullOrEmpty(expense.Category))
                                                {
                                                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-secondary); display: block; font-size: 14px; margin-top: 4px;">
                                                        Category: @expense.Category
                                                    </FluentLabel>
                                                }
                                            </div>
                                            <FluentLabel Typo="Typography.Body" Style="color: var(--palette-orange-foreground-1); font-weight: 600; font-size: 18px;">
                                                -$@expense.Amount.ToString("N2")
                                            </FluentLabel>
                                        </FluentStack>
                                    </FluentCard>
                                }
                            </div>
                        }

                        <!-- One-time Payments Section -->
                        @if (AdhocPayments?.Any() == true)
                        {
                            <div style="margin-bottom: 16px;">
                                <FluentLabel Typo="Typography.Body" Style="color: var(--palette-blue-foreground-1); margin-bottom: 8px; display: block; font-weight: 600;">
                                    ?? One-time Payments (@AdhocPayments.Count)
                                </FluentLabel>
                                @foreach (var adhocPayment in AdhocPayments)
                                {
                                    <FluentCard Class="item-card adhoc-payment-item" 
                                                Style="cursor: pointer; margin-bottom: 12px; padding: 16px;"
                                                @onclick="() => OnEditAdhocPayment.InvokeAsync(adhocPayment)">
                                        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="align-items: center;">
                                            <div style="flex: 1;">
                                                <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 16px;">
                                                    @adhocPayment.Description
                                                </FluentLabel>
                                                @if (!string.IsNullOrEmpty(adhocPayment.Category))
                                                {
                                                    <FluentLabel Typo="Typography.Body" Style="color: var(--neutral-foreground-secondary); display: block; font-size: 14px; margin-top: 4px;">
                                                        Category: @adhocPayment.Category
                                                    </FluentLabel>
                                                }
                                            </div>
                                            <FluentLabel Typo="Typography.Body" Style="color: var(--palette-blue-foreground-1); font-weight: 600; font-size: 18px;">
                                                +$@adhocPayment.Amount.ToString("N2")
                                            </FluentLabel>
                                        </FluentStack>
                                    </FluentCard>
                                }
                            </div>
                        }

                        <!-- Total Summary -->
                        @if (HasAnyItems)
                        {
                            <FluentCard Style="background-color: var(--neutral-layer-2); margin-top: 20px; padding: 20px;">
                                <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.SpaceBetween" Style="align-items: center;">
                                    <FluentLabel Typo="Typography.Body" Style="font-weight: 600; font-size: 18px;">
                                        Daily Total:
                                    </FluentLabel>
                                    <FluentLabel Typo="Typography.Body" Style="@($"{GetTotalAmountStyle()}; font-size: 20px;")">
                                        @GetTotalAmountText()
                                    </FluentLabel>
                                </FluentStack>
                            </FluentCard>
                        }
                    </FluentStack>
                }
            </FluentCard>
        </FluentStack>
    </FluentDialogBody>

    <FluentDialogFooter>
        <FluentStack Orientation="Orientation.Horizontal" HorizontalAlignment="HorizontalAlignment.End">
            <FluentButton Appearance="Appearance.Neutral" OnClick="OnClose">
                Close
            </FluentButton>
        </FluentStack>
    </FluentDialogFooter>
</FluentDialog>

<style>
    .item-card {
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .item-card:hover {
        transform: translateY(-1px);
        box-shadow: var(--elevation-shadow-tooltip);
    }

    .income-schedule-item {
        border-left: 4px solid var(--palette-green-foreground-1);
        background-color: var(--palette-green-background-1);
    }

    .income-schedule-item:hover {
        background-color: var(--palette-green-background-2);
        border-color: var(--palette-green-foreground-1);
    }

    .expense-schedule-item {
        border-left: 4px solid var(--palette-red-foreground-1);
        background-color: var(--palette-red-background-1);
    }

    .expense-schedule-item:hover {
        background-color: var(--palette-red-background-2);
        border-color: var(--palette-red-foreground-1);
    }

    .expense-item {
        border-left: 4px solid var(--palette-orange-foreground-1);
        background-color: var(--palette-orange-background-1);
    }

    .expense-item:hover {
        background-color: var(--palette-orange-background-2);
        border-color: var(--palette-orange-foreground-1);
    }

    .adhoc-payment-item {
        border-left: 4px solid var(--palette-blue-foreground-1);
        background-color: var(--palette-blue-background-1);
    }

    .adhoc-payment-item:hover {
        background-color: var(--palette-blue-background-2);
        border-color: var(--palette-blue-foreground-1);
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; } = false;
    [Parameter] public string Title { get; set; } = "Day Details";
    [Parameter] public DateOnly SelectedDate { get; set; }
    
    // Item collections for the selected day (unified)
    [Parameter] public List<RecurringScheduleItem>? RecurringSchedules { get; set; }
    [Parameter] public List<ExpenseItem>? Expenses { get; set; }
    [Parameter] public List<AdhocPaymentItem>? AdhocPayments { get; set; }

    // Event callbacks for actions
    [Parameter] public EventCallback OnClose { get; set; }
    
    // Add new item callbacks
    [Parameter] public EventCallback OnAddIncomeSchedule { get; set; }
    [Parameter] public EventCallback OnAddExpenseSchedule { get; set; }
    [Parameter] public EventCallback OnAddExpense { get; set; }
    [Parameter] public EventCallback OnAddPayment { get; set; }
    
    // Edit item callbacks
    [Parameter] public EventCallback<RecurringScheduleItem> OnEditRecurringSchedule { get; set; }
    [Parameter] public EventCallback<ExpenseItem> OnEditExpense { get; set; }
    [Parameter] public EventCallback<AdhocPaymentItem> OnEditAdhocPayment { get; set; }

    private bool HasAnyItems => 
        (RecurringSchedules?.Any() == true) ||
        (Expenses?.Any() == true) ||
        (AdhocPayments?.Any() == true);

    private decimal GetTotalAmount()
    {
        var recurringTotal = RecurringSchedules?.Sum(s => s.Amount) ?? 0;
        var expenseTotal = Expenses?.Sum(e => e.Amount) ?? 0;
        var adhocPaymentTotal = AdhocPayments?.Sum(a => a.Amount) ?? 0;
        
        return recurringTotal + adhocPaymentTotal - expenseTotal;
    }

    private string GetTotalAmountText()
    {
        var total = GetTotalAmount();
        var prefix = total >= 0 ? "+" : "";
        return $"{prefix}${Math.Abs(total):N2}";
    }

    private string GetTotalAmountStyle()
    {
        var total = GetTotalAmount();
        var color = total >= 0 ? "var(--palette-green-foreground-1)" : "var(--palette-red-foreground-1)";
        return $"color: {color}; font-weight: 600;";
    }
}